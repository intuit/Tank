<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
  xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:h="http://xmlns.jcp.org/jsf/html"
  xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:ts="http://xmlns.jcp.org/jsf/composite/tag"
  xmlns:p="http://primefaces.org/ui">

  <p:messages />
  <div class="vertical-spacer clear-both" />

  <!-- Action -->
  <div class="formRowDiv">
    <div class="formLabelDiv required float-left">Action</div>
    <div class="formInput float-left">
      <p:selectOneMenu value="#{webSocketStepEditor.action}">
        <p:ajax update=":webSocketForm:webSocketPanelGroup" />
        <f:selectItem itemLabel="Connect" itemValue="CONNECT" />
        <f:selectItem itemLabel="Send" itemValue="SEND" />
        <f:selectItem itemLabel="Assert" itemValue="ASSERT" />
        <f:selectItem itemLabel="Disconnect" itemValue="DISCONNECT" />
      </p:selectOneMenu>
    </div>
  </div>
  <div class="vertical-spacer clear-both" />

  <!-- CONNECT -->
  <h:panelGroup rendered="#{webSocketStepEditor.action == 'CONNECT'}">
    <div class="formRowDiv">
      <div class="formLabelDiv required float-left">WebSocket URL</div>
      <div class="formInput float-left">
        <h:inputText value="#{webSocketStepEditor.url}" size="40" style="width: 400px;" />
      </div>
    </div>
    <div class="vertical-spacer clear-both" />

    <div class="formRowDiv">
      <div class="formLabelDiv float-left">Timeout (ms)</div>
      <div class="formInput float-left">
        <h:inputText value="#{webSocketStepEditor.timeoutMs}" size="12" />
      </div>
    </div>
    <div class="vertical-spacer clear-both" />

    <div class="formRowDiv">
      <div class="formLabelDiv float-left">
        Fail-On Patterns
        <ts:tip tipId="wsFailOnTip"
          text="Checked against every incoming message while the connection is open. If a match is found, the connection is marked failed and later SEND/ASSERT steps fail. Examples: Plain text: error. Regex: .*fatal.*" />
      </div>
      <div class="formInput float-left" style="width: 480px;">
        <ui:repeat value="#{webSocketStepEditor.failOnEntries}" var="failOn" varStatus="status">
          <div class="vertical-spacer clear-both" />
          <h:inputText value="#{failOn.pattern}" size="28" style="width: 250px;" />
          <h:outputText value=" Regex " style="margin-left: 10px;" />
          <p:selectBooleanCheckbox value="#{failOn.regex}" />
          <p:commandButton value="Remove" process="@this"
            action="#{webSocketStepEditor.removeFailOnEntry(status.index)}"
            update=":webSocketForm:webSocketPanelGroup" styleClass="icon-button h-space" />
        </ui:repeat>
        <div class="vertical-spacer clear-both" />
        <p:commandButton value="Add Fail-On" process="@this"
          action="#{webSocketStepEditor.addFailOnEntry}"
          update=":webSocketForm:webSocketPanelGroup" styleClass="icon-button h-space" />
      </div>
    </div>
    <div class="vertical-spacer clear-both" />
  </h:panelGroup>

  <!-- SEND -->
  <h:panelGroup rendered="#{webSocketStepEditor.action == 'SEND'}">
    <div class="formRowDiv">
      <div class="formLabelDiv required float-left">WebSocket URL</div>
      <div class="formInput float-left">
        <h:inputText value="#{webSocketStepEditor.url}" size="40" style="width: 400px;" />
      </div>
    </div>
    <div class="vertical-spacer clear-both" />

    <div class="formRowDiv">
      <div class="formLabelDiv float-left">Timeout (ms)</div>
      <div class="formInput float-left">
        <h:inputText value="#{webSocketStepEditor.timeoutMs}" size="12" />
      </div>
    </div>
    <div class="vertical-spacer clear-both" />

    <div class="formRowDiv">
      <div class="formLabelDiv float-left">Message Payload</div>
      <div class="formInput float-left">
        <h:inputTextarea value="#{webSocketStepEditor.payload}" rows="6" cols="40" 
                         style="font-family: monospace; width: 400px;" />
      </div>
    </div>
    <div class="vertical-spacer clear-both" />
  </h:panelGroup>

  <!-- ASSERT + DISCONNECT -->
  <h:panelGroup rendered="#{webSocketStepEditor.action == 'ASSERT' or webSocketStepEditor.action == 'DISCONNECT'}">
    <div class="formRowDiv">
      <div class="formLabelDiv required float-left">Connection</div>
      <div class="formInput float-left">
        <p:selectOneMenu value="#{webSocketStepEditor.selectedConnectionId}" style="width: 420px;">
          <p:ajax update=":webSocketForm:webSocketPanelGroup" />
          <f:selectItem itemLabel="Select active connection" itemValue="" />
          <f:selectItems value="#{webSocketStepEditor.availableConnectionOptions}" />
        </p:selectOneMenu>
      </div>
    </div>
    <div class="vertical-spacer clear-both" />

    <div class="formRowDiv">
      <div class="formLabelDiv float-left">Resolved URL</div>
      <div class="formInput float-left">
        <h:outputText value="#{webSocketStepEditor.urlForSelectedConnection}" />
      </div>
    </div>
    <div class="vertical-spacer clear-both" />

    <div class="formRowDiv">
      <div class="formLabelDiv float-left">
        Expect Assertions
        <ts:tip tipId="wsExpectTip"
          text="Validated during ASSERT or DISCONNECT using collected messages. Min/Max are inclusive match counts. Examples: Exactly once: pattern=order-confirmed, min=1, max=1. At least one regex match: pattern='status':'(ok|ready)', regex=true, min=1." />
      </div>
      <div class="formInput float-left" style="width: 520px;">
        <ui:repeat value="#{webSocketStepEditor.expectEntries}" var="expect" varStatus="status">
          <div class="vertical-spacer clear-both" />
          <h:inputText value="#{expect.pattern}" size="20" style="width: 170px;" />
          <h:outputText value=" Regex " style="margin-left: 8px;" />
          <p:selectBooleanCheckbox value="#{expect.regex}" />
          <h:outputText value=" Min " style="margin-left: 8px;" />
          <h:inputText value="#{expect.minCount}" size="4" />
          <h:outputText value=" Max " style="margin-left: 8px;" />
          <h:inputText value="#{expect.maxCount}" size="4" />
          <p:commandButton value="Remove" process="@this"
            action="#{webSocketStepEditor.removeExpectEntry(status.index)}"
            update=":webSocketForm:webSocketPanelGroup" styleClass="icon-button h-space" />
        </ui:repeat>
        <div class="vertical-spacer clear-both" />
        <p:commandButton value="Add Expect" process="@this"
          action="#{webSocketStepEditor.addExpectEntry}"
          update=":webSocketForm:webSocketPanelGroup" styleClass="icon-button h-space" />
      </div>
    </div>
    <div class="vertical-spacer clear-both" />

    <div class="formRowDiv">
      <div class="formLabelDiv float-left">
        Save Assertions
        <ts:tip tipId="wsSaveTip"
          text="Find a message that matches Pattern and save the matched content to Variable. Variable is required when Pattern is set. Occurrence chooses first or last match. Examples: Save last plain match: pattern=sessionId=, variable=sessionValue, occurrence=last. Save first regex match: pattern=token=([A-Za-z0-9_-]+), regex=true, variable=authToken, occurrence=first." />
      </div>
      <div class="formInput float-left" style="width: 560px;">
        <ui:repeat value="#{webSocketStepEditor.saveEntries}" var="save" varStatus="status">
          <div class="vertical-spacer clear-both" />
          <h:inputText value="#{save.pattern}" size="20" style="width: 170px;" />
          <h:outputText value=" Regex " style="margin-left: 8px;" />
          <p:selectBooleanCheckbox value="#{save.regex}" />
          <h:outputText value=" Variable " style="margin-left: 8px;" />
          <h:inputText value="#{save.variable}" size="10" />
          <h:outputText value=" Occurrence " style="margin-left: 8px;" />
          <p:selectOneMenu value="#{save.occurrence}" style="width: 90px;">
            <f:selectItem itemLabel="Last" itemValue="last" />
            <f:selectItem itemLabel="First" itemValue="first" />
          </p:selectOneMenu>
          <p:commandButton value="Remove" process="@this"
            action="#{webSocketStepEditor.removeSaveEntry(status.index)}"
            update=":webSocketForm:webSocketPanelGroup" styleClass="icon-button h-space" />
        </ui:repeat>
        <div class="vertical-spacer clear-both" />
        <p:commandButton value="Add Save" process="@this"
          action="#{webSocketStepEditor.addSaveEntry}"
          update=":webSocketForm:webSocketPanelGroup" styleClass="icon-button h-space" />
      </div>
    </div>
    <div class="vertical-spacer clear-both" />
  </h:panelGroup>

  <div class="vertical-spacer clear-both" />
</ui:composition>
