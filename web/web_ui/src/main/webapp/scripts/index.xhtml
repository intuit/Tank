<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:s="http://jboss.org/seam/faces"
  xmlns:ts="http://java.sun.com/jsf/composite/tag"
  xmlns:fn="http://java.sun.com/jsp/jstl/functions"
  xmlns:p="http://primefaces.org/ui"
  xmlns:pe="http://primefaces.org/ui/extensions"
  template="/WEB-INF/templates/tank.xhtml">
  <ui:define name="content">
    <s:viewAction action="#{tsConversationManager.end}" />

    <h:form id="mainForm">

      <ts:toolbar title="Scripts" objectName="Scripts"
        reRender=":mainForm:scriptTableId"
        selectionTracker="#{scriptBean}" id="toolbar"
        showRightComponents="true">
        <f:facet name="actions">
          <h:panelGroup styleClass="toolbar-ui" layout="block">
           <div class="toolbar-ui">
            <p:commandButton value="New Script"
              action="#{scriptCreationBean.createNewScript()}" ajax="true" icon="ui-icon-plus"
              rendered="#{scriptCreationBean.canCreateScript()}" style="margin: 0 10px 0 20px; border-radius:5px">
            </p:commandButton>
            <p:commandButton value="Import Intuit Tank XML"
              oncomplete="PF('xmlUploadDialog').show();"
              immediate="true"
              action="#{tankXmlUploadBean.clearDialog}"
              style=" background-image: url(#{request.contextPath}/resources/gfx/16/document_import.png);
                    background-repeat: no-repeat;
                    background-position: 3px 5px;
                    vertical-align: top;
                    border-radius:5px;"
              styleClass="icon-button h-space"
              rendered="#{scriptCreationBean.canCreateScript()}">
            </p:commandButton>
          </div>
          </h:panelGroup>
        </f:facet>
        <f:facet name="additional-group">
          <p:selectCheckboxMenu
            value="#{scriptBean.tablePrefs.visibleColumns}"
            style="margin: 0 10px 0 20px;" panelStyle="width:300px;"
            label="Visible Columns...">
            <p:ajax event="change" update=":mainForm:scriptTableId"
              process="@this" onstart="saveScrollPos()"
              oncomplete="getScrollPos()" immediate="true" />
            <p:ajax event="toggleSelect"
              update=":mainForm:scriptTableId" process="@this"
              onstart="saveScrollPos()" oncomplete="getScrollPos()"
              immediate="true" />
            <f:selectItems
              value="#{scriptBean.tablePrefs.visibiltyList}" />
          </p:selectCheckboxMenu>
        </f:facet>
      </ts:toolbar>

      <div class="vertical-spacer" />
      <p:growl globalOnly="true" id="messages" autoUpdate="true" />
      <pe:remoteCommand id="resizeListener" name="resizeFinished"
        update="scriptTableId" />


      <p:dataTable value="#{scriptBean.selectionList}" var="selectable"
        widgetVar="scriptTable" id="scriptTableId" liveResize=" false"
        scrollable="true" filteredValue="#{scriptBean.filteredData}"
        style="width:#{scriptBean.tablePrefs.getMaxTotalSize(preferencesBean.screenWidth)}px;"
        scrollHeight="450" sortBy="#{selectable.entity.created}"
        sortOrder="descending" paginator="true" rows="25"
        resizableColumns="true"
        paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
        rowsPerPageTemplate="25,50,75,100">


        <f:facet name="header">
          <p:outputPanel style="text-align: right; width:100%"
            layout="block">
            <h:outputText value="Search all fields: " />
            <p:inputText id="globalFilter"
              onkeyup="PF('scriptTable').filter()" style="width:150px" />
          </p:outputPanel>
        </f:facet>

        <p:ajax event="colResize" update="scriptTableId"
          listener="#{scriptBean.tablePrefs.onResize}" global="true"
          onstart="saveScrollPos()" oncomplete="getScrollPos()"
          immediate="true" />

        <p:ajax event="filter"
          listener="#{scriptBean.tableState.onFilter}" global="false"
          immediate="true" />


        <p:column id="selectColumn" styleClass="select-column ellipsis"
          width="#{scriptBean.tablePrefs.getSize('selectColumn')}"
          rendered="#{scriptBean.tablePrefs.isVisible('selectColumn')}"
          resizable="false">
          <p:selectBooleanCheckbox value="#{selectable.selected}"
            id="selectBox">
            <p:ajax event="change"
              update=":mainForm:toolbar:deleteSelectedBtn" />
          </p:selectBooleanCheckbox>
        </p:column>

        <p:column id="idColumn" headerText="ID"
          styleClass="ellipsis min-column-size"
          width="#{scriptBean.tablePrefs.getSize('idColumn')}"
          rendered="#{scriptBean.tablePrefs.isVisible('idColumn')}"
          filterValue="#{scriptBean.tableState.getFilterValue('entity.id')}"
          filterStyle="width:40px;" sortBy="#{selectable.entity.id}"
          filterBy="#{selectable.entity.id}" filterFunction="#{filterUtil.contains}">
          <h:outputText value="#{selectable.entity.id}" />
        </p:column>


        <p:column id="nameColumn" headerText="Name"
          sortBy="#{selectable.entity.name}"
          styleClass="ellipsis min-column-size"
          width="#{scriptBean.tablePrefs.getSize('nameColumn')}"
          rendered="#{scriptBean.tablePrefs.isVisible('nameColumn')}"
          filterValue="#{scriptBean.tableState.getFilterValue('entity.name')}"
          filterStyle="width:75px;" filterBy="#{selectable.entity.name}"
          filterFunction="#{filterUtil.contains}">
          <p:commandLink
            action="#{scriptEditor.editScript(selectable.entity)}"
            title="#{selectable.entity.name} (id=#{selectable.entity.id})"
            ajax="true">
            <h:outputText value="#{selectable.entity.name}" />
          </p:commandLink>
        </p:column>

        <p:column id="productColumn" headerText="Product"
          styleClass="ellipsis min-column-size"
          width="#{scriptBean.tablePrefs.getSize('productColumn')}"
          rendered="#{scriptBean.tablePrefs.isVisible('productColumn')}"
          filterValue="#{scriptBean.tableState.getFilterValue('entity.productName')}"
          filterStyle="width:75px;"
          sortBy="#{selectable.entity.productName}"
          filterBy="#{selectable.entity.productName}"
          filterOptions="#{projectUtilBean.productNames}"
          filterMatchMode="exact">
          <h:outputText value="#{selectable.entity.productName}" />
        </p:column>

        <p:column id="commentsColumn" headerText="Comments"
          styleClass="ellipsis min-column-size"
          width="#{scriptBean.tablePrefs.getSize('commentsColumn')}"
          rendered="#{scriptBean.tablePrefs.isVisible('commentsColumn')}"
          filterValue="#{scriptBean.tableState.getFilterValue('entity.comments')}"
          filterStyle="width:75px;"
          sortBy="#{selectable.entity.comments}"
          filterBy="#{selectable.entity.comments}"
          filterFunction="#{filterUtil.contains}">
          <h:outputText value="#{selectable.entity.comments}"
            title="#{selectable.entity.comments}" />
        </p:column>

        <p:column id="createColumn" headerText="Created"
          styleClass="ellipsis min-column-size"
          width="#{scriptBean.tablePrefs.getSize('createColumn')}"
          rendered="#{scriptBean.tablePrefs.isVisible('createColumn')}"
          filterValue="#{scriptBean.tableState.getFilterValue('formatDate(entity.created)')}"
          filterStyle="width:75px;"
          sortBy="#{selectable.entity.created}"
          filterBy="#{preferencesBean.formatDate(selectable.entity.created)}"
          filterFunction="#{filterUtil.contains}">
          <h:outputText value="#{selectable.entity.created}"
            converter="#{dateConverter}" />
        </p:column>

        <p:column id="modifiedColumn"
          styleClass="ellipsis min-column-size" headerText="Modified"
          width="#{scriptBean.tablePrefs.getSize('modifiedColumn')}"
          rendered="#{scriptBean.tablePrefs.isVisible('modifiedColumn')}"
          filterValue="#{scriptBean.tableState.getFilterValue('formatDate(entity.modified)')}"
          filterStyle="width:75px;"
          sortBy="#{selectable.entity.modified}"
          filterBy="#{preferencesBean.formatDate(selectable.entity.modified)}"
          filterFunction="#{filterUtil.contains}">
          <h:outputText value="#{selectable.entity.modified}"
            converter="#{dateConverter}" />
        </p:column>

        <p:column id="ownerColumn" headerText="Owner"
          styleClass="ellipsis min-column-size"
          width="#{scriptBean.tablePrefs.getSize('ownerColumn')}"
          rendered="#{scriptBean.tablePrefs.isVisible('ownerColumn')}"
          filterValue="#{scriptBean.tableState.getFilterValue('entity.creator)')}"
          sortBy="#{selectable.entity.creator}"
          filterBy="#{selectable.entity.creator}"
          filterMatchMode="exact"
          filterOptions="#{scriptBean.creatorList}">
          <h:outputText value="#{selectable.entity.creator}" />
        </p:column>


        <p:column id="actionsColumn"
          styleClass="ellipsis 
        actions-column-large"
          width="100"
          rendered="#{scriptBean.tablePrefs.isVisible('actionsColumn')}"
          resizable="false">

          <p:commandLink title="Delete #{selectable.entity.name}"
            oncomplete="PF('confirmDelete').show();" ajax="true"
            action="#{scriptBean.setSelectedScript(selectable)}"
            update=":confirmDeleteDialogId">
            <h:graphicImage library="gfx" name="16/delete.png"
              width="16px" height="16px" style="padding: 2px;" />
          </p:commandLink>

          <p:commandLink id="btnOpen"
            action="#{scriptEditor.editScript(selectable.entity)}"
            styleClass="pointer" ajax="true">
            <h:graphicImage
              library="gfx" name="16/document_editing.png"
              width="16px" height="16px" style="padding: 2px;"
              title="Edit #{selectable.entity.name}" />
          </p:commandLink>

          <p:commandLink title="Save As"
            oncomplete="PF('saveAsConfirm').show();" ajax="true"
            action="#{scriptBean.setSelectedScript(selectable)}"
            update=":saveAsConfirmForm:saveAsConfirmId">
            <h:graphicImage library="gfx" name="16/save_as.png"
              width="16px" height="16px" style="padding: 2px;" />
          </p:commandLink>

          <p:commandLink id="downloadHarnessBT"
            title="Download Harness XML"
            onclick="location.href='#{request.contextPath}/rest/v1/script-service/download/harness/script/#{selectable.entity.id}'">
            <h:graphicImage library="gfx" name="16/download.png"
              width="16px" height="16px" style="padding: 2px;"
              title="Download Harness XML" />
          </p:commandLink>
          <p:commandLink id="downloadTSBT"
            title="Download Intuit Tank XML"
            onclick="location.href='#{request.contextPath}/rest/v1/script-service/download/script/#{selectable.entity.id}'">
            <h:graphicImage library="gfx" name="16/download.png"
              width="16px" height="16px" style="padding: 2px;"
              title="Download Tank XML" />
          </p:commandLink>

        </p:column>
      </p:dataTable>
    </h:form>

    <p:confirmDialog id="confirmDeleteDialogId" appendTo="@(body)"
      widgetVar="confirmDelete" header="Confirm Delete"
      message="Are you sure you want to delete Script #{scriptBean.selectedScript.entity.name}?">
      <h:form id="confirmDeletemainForm">
        <p:commandButton value="OK" id="confirmDeleteOkBtn"
          action="#{scriptBean.delete(scriptBean.selectedScript.entity)}"
          onsuccess="PF('confirmDelete').hide()"
          update=":mainForm:scriptTableId" ajax="true" />
        <h:panelGroup styleClass="horizontal-spacer" />
        <p:commandButton value="Cancel"
          onclick="PF('confirmDelete').hide();" type="button">
        </p:commandButton>
      </h:form>
    </p:confirmDialog>

    <p:dialog id="xmlUploadDialogID" header="Upload Intuit Tank XML"
      widgetVar="xmlUploadDialog" position="center" width="600"
      height="200" modal="true">
      <h:form id="uploadForm">
        <p:outputPanel>
          <h:outputText styleClass="pa"
            value="Intuit Tank supports only .xml files as Scripts but can accept .zip files. Zip files will be searched recursively for all .xml files." />
          <div class="vertical-spacer" />
          <p:fileUpload id="fileUploadControl"
            oncomplete="PF('xmlUploadDialog').hide()"
            fileUploadListener="#{tankXmlUploadBean.handleFileUpload}"
            mode="advanced" allowTypes="/(\.|\/)(xml|zip)$/"
            update=":mainForm:scriptTableId" multiple="true" />
          <div class="vertical-spacer" />
        </p:outputPanel>
      </h:form>
    </p:dialog>

    <h:form id="saveAsConfirmForm">
      <p:confirmDialog id="saveAsConfirmId" header="Save As"
         widgetVar="saveAsConfirm">
        <f:facet name="message">
          <h:outputText value="Save As: " />
          <h:inputText value="#{scriptBean.saveAsName}"
            styleClass="formInput inputWidthMedium" style="width:140px;" />
        </f:facet>
        <p:commandButton value="OK" id="SaveAsOk" ajax="true"
          action="#{scriptBean.saveAs(scriptBean.selectedScript.entity)}"
          update=":mainForm:scriptTableId"
          onsuccess="PF('saveAsConfirm').hide();" />
        <h:panelGroup styleClass="horizontal-spacer" />
        <p:commandButton value="Cancel"
          onclick="PF('saveAsConfirm').hide();" id="saveAsCancel"
          type="button" />
      </p:confirmDialog>
    </h:form>

  </ui:define>
</ui:composition>
